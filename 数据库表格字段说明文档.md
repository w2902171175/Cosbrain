# 数据库表格字段说明文档

本文档详细描述了鸿庆书云创新协作平台的数据库表结构，共包含 **28个数据表**。

## 目录

1. [核心用户和项目表](#1-核心用户和项目表)
2. [聊天和通讯相关表](#2-聊天和通讯相关表)
3. [论坛社区功能表](#3-论坛社区功能表)
4. [知识管理系统表](#4-知识管理系统表)
5. [个人内容管理表](#5-个人内容管理表)
6. [课程管理表](#6-课程管理表)
7. [积分系统和成就系统表](#7-积分系统和成就系统表)
8. [AI对话系统表](#8-ai对话系统表)
9. [系统配置表](#9-系统配置表)

---

## 1. 核心用户和项目表

### 1.1 students (学生/用户信息表)

存储平台用户的基本信息、技能、偏好、积分等。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 用户唯一标识符 |
| email | String | UNIQUE, INDEX, NULLABLE | 用户邮箱地址 |
| password_hash | String | NULLABLE | 加密后的密码 |
| username | String | UNIQUE, INDEX, NOT NULL, DEFAULT="新用户" | 用户名 |
| phone_number | String | UNIQUE, INDEX, NULLABLE | 手机号码 |
| school | String | NULLABLE | 所在学校 |
| name | String | INDEX | 用户姓名 |
| major | String | NULLABLE | 专业 |
| skills | JSONB | NOT NULL, DEFAULT='[]' | 技能列表，包含名称和熟练度 |
| interests | Text | NULLABLE | 兴趣爱好 |
| bio | Text | DEFAULT="欢迎使用本平台！" | 个人简介 |
| awards_competitions | Text | NULLABLE | 获奖和竞赛经历 |
| academic_achievements | Text | NULLABLE | 学术成就 |
| soft_skills | Text | NULLABLE | 软技能 |
| portfolio_link | String | NULLABLE | 作品集链接 |
| preferred_role | String | NULLABLE | 偏好角色 |
| availability | String | NULLABLE | 可用时间 |
| location | String | NULLABLE | 地理位置 |
| combined_text | Text | NULLABLE | 合并文本（用于搜索） |
| embedding | Vector(1024) | NULLABLE | 向量嵌入 |
| llm_api_type | String | NULLABLE | LLM API类型 |
| llm_api_key_encrypted | Text | NULLABLE | 加密的LLM API密钥 |
| llm_api_base_url | String | NULLABLE | LLM API基础URL |
| llm_model_id | String | NULLABLE | LLM模型ID |
| total_points | Integer | NOT NULL, DEFAULT=0 | 用户当前总积分 |
| last_login_at | DateTime | NULLABLE | 上次登录时间 |
| login_count | Integer | NOT NULL, DEFAULT=0 | 总登录天数 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |
| is_admin | Boolean | NOT NULL, DEFAULT=False | 是否管理员 |

### 1.2 projects (项目信息表)

存储项目的基本信息、需求技能、状态等。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 项目唯一标识符 |
| title | String | INDEX | 项目标题 |
| description | Text | | 项目描述 |
| required_skills | JSONB | NOT NULL, DEFAULT='[]' | 所需技能列表 |
| required_roles | JSONB | NOT NULL, DEFAULT='[]' | 所需角色列表 |
| keywords | String | | 关键词 |
| project_type | String | | 项目类型 |
| expected_deliverables | Text | | 预期交付物 |
| contact_person_info | String | | 联系人信息 |
| learning_outcomes | Text | | 学习成果 |
| team_size_preference | String | | 团队规模偏好 |
| project_status | String | | 项目状态 |
| start_date | DateTime | NULLABLE | 项目开始日期 |
| end_date | DateTime | NULLABLE | 项目结束日期 |
| estimated_weekly_hours | Integer | NULLABLE | 估计每周所需小时数 |
| location | String | NULLABLE | 项目地理位置 |
| creator_id | Integer | FOREIGN KEY(students.id), NOT NULL | 项目创建者ID |
| combined_text | Text | | 合并文本（用于搜索） |
| embedding | Vector(1024) | | 向量嵌入 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

---

## 2. 聊天和通讯相关表

### 2.1 chat_rooms (聊天室表)

存储聊天室的基本信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 聊天室唯一标识符 |
| name | String | NOT NULL, UNIQUE | 聊天室名称 |
| type | String | NOT NULL, DEFAULT="general" | 聊天室类型 |
| project_id | Integer | FOREIGN KEY(projects.id), NULLABLE, UNIQUE | 关联项目ID |
| course_id | Integer | FOREIGN KEY(courses.id), NULLABLE, UNIQUE | 关联课程ID |
| creator_id | Integer | FOREIGN KEY(students.id), NOT NULL | 群主ID |
| color | String | NULLABLE | 聊天室颜色 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 2.2 chat_messages (聊天消息表)

存储聊天消息内容。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 消息唯一标识符 |
| room_id | Integer | FOREIGN KEY(chat_rooms.id), NOT NULL | 聊天室ID |
| sender_id | Integer | FOREIGN KEY(students.id), NOT NULL | 发送者ID |
| content_text | Text | NOT NULL | 消息文本内容 |
| message_type | String | DEFAULT="text" | 消息类型 |
| media_url | String | NULLABLE | 媒体文件URL |
| sent_at | DateTime | SERVER_DEFAULT=func.now() | 发送时间 |

### 2.3 chat_room_members (聊天室成员表)

管理聊天室成员关系。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 成员关系唯一标识符 |
| room_id | Integer | FOREIGN KEY(chat_rooms.id), NOT NULL, INDEX | 聊天室ID |
| member_id | Integer | FOREIGN KEY(students.id), NOT NULL, INDEX | 成员ID |
| role | String | NOT NULL, DEFAULT="member" | 角色类型（admin/member） |
| status | String | NOT NULL, DEFAULT="active" | 成员状态（active/banned/left） |
| joined_at | DateTime | NOT NULL, DEFAULT=func.now() | 加入时间 |

**约束：** UNIQUE(room_id, member_id)

### 2.4 chat_room_join_requests (聊天室加入请求表)

管理聊天室加入申请。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 请求唯一标识符 |
| room_id | Integer | FOREIGN KEY(chat_rooms.id), NOT NULL, INDEX | 聊天室ID |
| requester_id | Integer | FOREIGN KEY(students.id), NOT NULL, INDEX | 申请者ID |
| reason | String | NULLABLE | 申请理由 |
| status | String | NOT NULL, DEFAULT="pending" | 状态（pending/approved/rejected） |
| requested_at | DateTime | NOT NULL, DEFAULT=func.now() | 申请时间 |
| processed_by_id | Integer | FOREIGN KEY(students.id), NULLABLE | 处理者ID |
| processed_at | DateTime | NULLABLE | 处理时间 |

**特殊约束：** 确保一个用户在一个聊天室中最多只有一个 'pending' 状态的申请

---

## 3. 论坛社区功能表

### 3.1 forum_topics (论坛话题表)

存储论坛话题信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 话题唯一标识符 |
| owner_id | Integer | FOREIGN KEY(students.id), NOT NULL | 话题发布者ID |
| title | String | NOT NULL | 话题标题 |
| content | Text | NOT NULL | 话题内容 |
| shared_item_type | String | NULLABLE | 分享项目类型 |
| shared_item_id | Integer | NULLABLE | 分享项目ID |
| tags | String | NULLABLE | 标签 |
| likes_count | Integer | DEFAULT=0 | 点赞数 |
| comments_count | Integer | DEFAULT=0 | 评论数 |
| views_count | Integer | DEFAULT=0 | 浏览数 |
| combined_text | Text | | 合并文本（用于搜索） |
| embedding | Vector(1024) | | 向量嵌入 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 3.2 forum_comments (论坛评论表)

存储论坛评论信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 评论唯一标识符 |
| topic_id | Integer | FOREIGN KEY(forum_topics.id), NOT NULL | 话题ID |
| owner_id | Integer | FOREIGN KEY(students.id), NOT NULL | 评论者ID |
| content | Text | NOT NULL | 评论内容 |
| parent_comment_id | Integer | FOREIGN KEY(forum_comments.id), NULLABLE | 父评论ID（支持嵌套评论） |
| likes_count | Integer | DEFAULT=0 | 点赞数 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 3.3 forum_likes (论坛点赞表)

记录论坛点赞信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 点赞唯一标识符 |
| owner_id | Integer | FOREIGN KEY(students.id), NOT NULL | 点赞者ID |
| topic_id | Integer | FOREIGN KEY(forum_topics.id), NULLABLE | 话题ID |
| comment_id | Integer | FOREIGN KEY(forum_comments.id), NULLABLE | 评论ID |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 点赞时间 |

### 3.4 user_follows (用户关注表)

管理用户之间的关注关系。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 关注关系唯一标识符 |
| follower_id | Integer | FOREIGN KEY(students.id), NOT NULL | 关注者ID |
| followed_id | Integer | FOREIGN KEY(students.id), NOT NULL | 被关注者ID |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 关注时间 |

---

## 4. 知识管理系统表

### 4.1 knowledge_bases (知识库表)

存储知识库基本信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 知识库唯一标识符 |
| owner_id | Integer | FOREIGN KEY(students.id) | 知识库所有者ID |
| name | String | INDEX, NOT NULL | 知识库名称 |
| description | Text | | 知识库描述 |
| access_type | String | | 访问类型 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 4.2 knowledge_articles (知识文章表)

存储知识库文章。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 文章唯一标识符 |
| kb_id | Integer | FOREIGN KEY(knowledge_bases.id) | 知识库ID |
| author_id | Integer | FOREIGN KEY(students.id) | 作者ID |
| title | String | INDEX | 文章标题 |
| content | Text | | 文章内容 |
| version | String | | 版本 |
| tags | String | | 标签 |
| combined_text | Text | | 合并文本（用于搜索） |
| embedding | Vector(1024) | | 向量嵌入 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 4.3 knowledge_documents (知识文档表)

存储上传的文档文件。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 文档唯一标识符 |
| kb_id | Integer | FOREIGN KEY(knowledge_bases.id), NOT NULL | 知识库ID |
| owner_id | Integer | FOREIGN KEY(students.id), NOT NULL | 文档所有者ID |
| file_name | String | NOT NULL | 文件名 |
| file_path | String | NOT NULL | 文件路径 |
| file_type | String | NULLABLE | 文件类型 |
| status | String | DEFAULT="processing" | 处理状态 |
| processing_message | Text | NULLABLE | 处理消息 |
| total_chunks | Integer | DEFAULT=0 | 总块数 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 4.4 knowledge_document_chunks (知识文档块表)

存储文档分块信息（用于RAG）。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 块唯一标识符 |
| document_id | Integer | FOREIGN KEY(knowledge_documents.id), NOT NULL | 文档ID |
| owner_id | Integer | FOREIGN KEY(students.id), NOT NULL | 所有者ID |
| kb_id | Integer | FOREIGN KEY(knowledge_bases.id), NOT NULL | 知识库ID |
| chunk_index | Integer | NOT NULL | 块索引 |
| content | Text | NOT NULL | 块内容 |
| embedding | Vector(1024) | | 向量嵌入 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |

---

## 5. 个人内容管理表

### 5.1 notes (笔记表)

存储用户个人笔记。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 笔记唯一标识符 |
| owner_id | Integer | FOREIGN KEY(students.id) | 笔记所有者ID |
| title | String | | 笔记标题 |
| content | Text | | 笔记内容 |
| note_type | String | | 笔记类型 |
| course_id | Integer | FOREIGN KEY(courses.id), NULLABLE | 关联课程ID |
| tags | String | | 标签 |
| combined_text | Text | | 合并文本（用于搜索） |
| embedding | Vector(1024) | | 向量嵌入 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 5.2 daily_records (日常记录表)

存储用户日常记录。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 记录唯一标识符 |
| owner_id | Integer | FOREIGN KEY(students.id) | 记录所有者ID |
| content | Text | NOT NULL | 记录内容 |
| mood | String | NULLABLE | 心情 |
| tags | String | NULLABLE | 标签 |
| combined_text | Text | | 合并文本（用于搜索） |
| embedding | Vector(1024) | | 向量嵌入 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 5.3 folders (文件夹表)

管理用户的收藏文件夹。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 文件夹唯一标识符 |
| owner_id | Integer | FOREIGN KEY(students.id) | 文件夹所有者ID |
| name | String | NOT NULL | 文件夹名称 |
| description | Text | NULLABLE | 文件夹描述 |
| color | String | NULLABLE | 文件夹颜色 |
| icon | String | NULLABLE | 文件夹图标 |
| parent_id | Integer | FOREIGN KEY(folders.id), NULLABLE, INDEX | 父文件夹ID（支持嵌套） |
| order | Integer | DEFAULT=0 | 排序 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 5.4 collected_contents (收藏内容表)

存储用户收藏的内容。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 收藏内容唯一标识符 |
| owner_id | Integer | FOREIGN KEY(students.id) | 收藏者ID |
| folder_id | Integer | FOREIGN KEY(folders.id), NULLABLE | 所属文件夹ID |
| title | String | NOT NULL | 内容标题 |
| type | String | NOT NULL | 内容类型 |
| url | String | NULLABLE | 内容URL |
| content | Text | NULLABLE | 内容详情 |
| tags | String | NULLABLE | 标签 |
| priority | Integer | DEFAULT=3 | 优先级 |
| notes | Text | NULLABLE | 备注 |
| access_count | Integer | DEFAULT=0 | 访问次数 |
| is_starred | Boolean | DEFAULT=False | 是否加星标 |
| thumbnail | String | NULLABLE | 缩略图 |
| author | String | NULLABLE | 作者 |
| duration | String | NULLABLE | 时长 |
| file_size | String | NULLABLE | 文件大小 |
| status | String | DEFAULT="active" | 状态 |
| combined_text | Text | | 合并文本（用于搜索） |
| embedding | Vector(1024) | | 向量嵌入 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 5.5 collection_items (收藏项目表)

旧的收藏系统表（将来可能重构或删除）。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 收藏项目唯一标识符 |
| user_id | Integer | FOREIGN KEY(students.id) | 用户ID |
| item_type | String | | 项目类型 |
| item_id | Integer | | 项目ID |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |

---

## 6. 课程管理表

### 6.1 courses (课程表)

存储课程基本信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 课程唯一标识符 |
| title | String | INDEX | 课程标题 |
| description | Text | | 课程描述 |
| instructor | String | | 讲师 |
| category | String | | 课程分类 |
| total_lessons | Integer | | 总课时数 |
| avg_rating | Float | | 平均评分 |
| cover_image_url | String | NULLABLE | 课程封面图片URL |
| required_skills | JSONB | NOT NULL, DEFAULT='[]' | 所需基础技能列表 |
| combined_text | Text | | 合并文本（用于搜索） |
| embedding | Vector(1024) | | 向量嵌入 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 6.2 user_courses (用户课程关联表)

管理用户与课程的关联关系。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| student_id | Integer | FOREIGN KEY(students.id), PRIMARY KEY | 学生ID |
| course_id | Integer | FOREIGN KEY(courses.id), PRIMARY KEY | 课程ID |
| progress | Float | DEFAULT=0.0 | 学习进度 |
| status | String | DEFAULT="in_progress" | 学习状态 |
| last_accessed | DateTime | SERVER_DEFAULT=func.now(), ONUPDATE=func.now() | 最后访问时间 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |

### 6.3 course_materials (课程材料表)

存储课程相关的学习材料。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 材料唯一标识符 |
| course_id | Integer | FOREIGN KEY(courses.id), NOT NULL, INDEX | 课程ID |
| title | String | NOT NULL | 材料标题 |
| type | String | NOT NULL | 材料类型（file/link/text） |
| file_path | String | NULLABLE | 本地文件存储路径 |
| original_filename | String | NULLABLE | 原始上传文件名 |
| file_type | String | NULLABLE | 文件MIME类型 |
| size_bytes | Integer | NULLABLE | 文件大小（字节） |
| url | String | NULLABLE | 外部链接URL |
| content | Text | NULLABLE | 文本内容或描述 |
| combined_text | Text | NULLABLE | 合并文本（用于搜索） |
| embedding | Vector(1024) | NULLABLE | 向量嵌入 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

**约束：** 
- UNIQUE(course_id, title) - 同一课程下材料标题唯一
- UNIQUE(file_path) - 文件路径唯一

---

## 7. 积分系统和成就系统表

### 7.1 achievements (成就表)

定义系统中可获得的成就。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 成就唯一标识符 |
| name | String | UNIQUE, NOT NULL | 成就名称 |
| description | Text | NOT NULL | 成就描述 |
| criteria_type | String | NOT NULL | 达成条件类型 |
| criteria_value | Float | NOT NULL | 达成所需数值门槛 |
| badge_url | String | NULLABLE | 勋章图片URL |
| reward_points | Integer | DEFAULT=0, NOT NULL | 奖励积分 |
| is_active | Boolean | DEFAULT=True, NOT NULL | 是否启用 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 7.2 user_achievements (用户成就表)

记录用户获得的成就。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 成就记录唯一标识符 |
| user_id | Integer | FOREIGN KEY(students.id), NOT NULL | 用户ID |
| achievement_id | Integer | FOREIGN KEY(achievements.id), NOT NULL | 成就ID |
| earned_at | DateTime | NOT NULL, DEFAULT=func.now() | 获得时间 |
| is_notified | Boolean | DEFAULT=False, NOT NULL | 是否已通知 |

**约束：** UNIQUE(user_id, achievement_id) - 确保一个用户不会重复获得同一个成就

### 7.3 point_transactions (积分交易表)

记录用户积分变化。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 交易记录唯一标识符 |
| user_id | Integer | FOREIGN KEY(students.id), NOT NULL | 用户ID |
| amount | Integer | NOT NULL | 积分变化量（正数为获得，负数为消耗） |
| reason | String | NULLABLE | 变动理由描述 |
| transaction_type | String | NOT NULL | 交易类型 |
| related_entity_type | String | NULLABLE | 关联实体类型 |
| related_entity_id | Integer | NULLABLE | 关联实体ID |
| created_at | DateTime | NOT NULL, DEFAULT=func.now() | 交易时间 |

---

## 8. AI对话系统表

### 8.1 ai_conversations (AI对话表)

存储用户与AI的对话会话。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 对话唯一标识符 |
| user_id | Integer | FOREIGN KEY(students.id), NOT NULL, INDEX | 对话所属用户ID |
| title | String | NULLABLE | 对话标题 |
| created_at | DateTime | SERVER_DEFAULT=func.now(), NOT NULL | 对话创建时间 |
| last_updated | DateTime | SERVER_DEFAULT=func.now(), ONUPDATE=func.now(), NOT NULL | 最后更新时间 |

### 8.2 ai_conversation_messages (AI对话消息表)

存储AI对话中的具体消息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 消息唯一标识符 |
| conversation_id | Integer | FOREIGN KEY(ai_conversations.id), NOT NULL, INDEX | 所属对话ID |
| role | String | NOT NULL | 消息角色（user/assistant/tool_call/tool_output） |
| content | Text | NOT NULL | 消息内容 |
| tool_calls_json | JSONB | NULLABLE | 工具调用JSON数据 |
| tool_output_json | JSONB | NULLABLE | 工具输出JSON数据 |
| llm_type_used | String | NULLABLE | 使用的LLM类型 |
| llm_model_used | String | NULLABLE | 使用的LLM模型ID |
| sent_at | DateTime | SERVER_DEFAULT=func.now(), NOT NULL | 消息发送时间 |

---

## 9. 系统配置表

### 9.1 user_mcp_configs (用户MCP配置表)

存储用户的MCP配置信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 配置唯一标识符 |
| owner_id | Integer | FOREIGN KEY(students.id), NOT NULL | 配置所有者ID |
| name | String | NOT NULL | 配置名称 |
| mcp_type | String | NULLABLE | MCP类型 |
| base_url | String | NOT NULL | 基础URL |
| protocol_type | String | NULLABLE | 协议类型 |
| api_key_encrypted | Text | NULLABLE | 加密的API密钥 |
| is_active | Boolean | DEFAULT=True | 是否激活 |
| description | Text | NULLABLE | 描述 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 9.2 user_search_engine_configs (用户搜索引擎配置表)

存储用户的搜索引擎配置。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 配置唯一标识符 |
| owner_id | Integer | FOREIGN KEY(students.id), NOT NULL | 配置所有者ID |
| name | String | NOT NULL | 配置名称 |
| engine_type | String | NOT NULL | 搜索引擎类型 |
| api_key_encrypted | Text | NULLABLE | 加密的API密钥 |
| is_active | Boolean | DEFAULT=True | 是否激活 |
| description | Text | NULLABLE | 描述 |
| base_url | String | NULLABLE | 搜索引擎API的基础URL |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

### 9.3 user_tts_configs (用户TTS配置表)

存储用户的文本转语音配置。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, INDEX | 配置唯一标识符 |
| owner_id | Integer | FOREIGN KEY(students.id), NOT NULL | 配置所有者ID |
| name | String | NOT NULL | TTS配置名称 |
| tts_type | String | NOT NULL | 语音提供商类型 |
| api_key_encrypted | Text | NULLABLE | 加密的API密钥 |
| base_url | String | NULLABLE | API基础URL |
| model_id | String | NULLABLE | 语音模型ID |
| voice_name | String | NULLABLE | 语音名称或ID |
| is_active | Boolean | NOT NULL, DEFAULT=False | 是否当前激活的TTS配置 |
| created_at | DateTime | SERVER_DEFAULT=func.now() | 创建时间 |
| updated_at | DateTime | ONUPDATE=func.now() | 更新时间 |

**约束：** UNIQUE(owner_id, name) - 同一用户下配置名称唯一

---

## 数据库关系说明

### 主要外键关系

1. **用户关系**：
   - `projects.creator_id` → `students.id`
   - `chat_rooms.creator_id` → `students.id`
   - `notes.owner_id` → `students.id`
   - `knowledge_bases.owner_id` → `students.id`
   - `forum_topics.owner_id` → `students.id`
   - `ai_conversations.user_id` → `students.id`

2. **项目关系**：
   - `chat_rooms.project_id` → `projects.id`

3. **课程关系**：
   - `chat_rooms.course_id` → `courses.id`
   - `notes.course_id` → `courses.id`
   - `course_materials.course_id` → `courses.id`

4. **知识库关系**：
   - `knowledge_articles.kb_id` → `knowledge_bases.id`
   - `knowledge_documents.kb_id` → `knowledge_bases.id`
   - `knowledge_document_chunks.document_id` → `knowledge_documents.id`
   - `knowledge_document_chunks.kb_id` → `knowledge_bases.id`

5. **论坛关系**：
   - `forum_comments.topic_id` → `forum_topics.id`
   - `forum_comments.parent_comment_id` → `forum_comments.id` (自引用)
   - `forum_likes.topic_id` → `forum_topics.id`
   - `forum_likes.comment_id` → `forum_comments.id`

6. **收藏管理**：
   - `collected_contents.folder_id` → `folders.id`
   - `folders.parent_id` → `folders.id` (自引用，支持嵌套文件夹)

7. **积分和成就**：
   - `user_achievements.user_id` → `students.id`
   - `user_achievements.achievement_id` → `achievements.id`
   - `point_transactions.user_id` → `students.id`

8. **AI对话**：
   - `ai_conversation_messages.conversation_id` → `ai_conversations.id`

### 特殊约束

1. **唯一性约束**：
   - 用户在同一聊天室只能有一条成员记录
   - 用户在同一聊天室最多只能有一个待处理的加入请求
   - 用户TTS配置名称唯一
   - 同一课程下材料标题唯一
   - 用户不能重复获得同一个成就

2. **级联删除**：
   - 删除用户时，相关的成就、积分记录、AI对话等会被级联删除
   - 删除聊天室时，相关的消息、成员关系会被级联删除
   - 删除知识库时，相关的文章、文档会被级联删除
   - 删除AI对话时，相关的消息会被级联删除

3. **向量搜索支持**：
   - 多个表包含 `embedding` 字段，支持向量相似度搜索
   - `combined_text` 字段用于全文搜索

## 技术特性

1. **向量数据库支持**：使用 pgvector 扩展支持向量存储和搜索
2. **JSONB字段**：skills、required_skills、required_roles、tool_calls_json、tool_output_json 等使用JSONB存储复杂数据
3. **时间戳自动管理**：created_at 和 updated_at 字段自动管理
4. **数据加密**：敏感信息如API密钥进行加密存储
5. **软删除支持**：部分表通过status字段实现软删除
6. **嵌套结构支持**：文件夹和评论支持嵌套结构

## 版本更新说明

**最新更新时间**: 2025年8月12日

**主要变更**:
1. 修正了数据库表总数为28个
2. 新增了AI对话系统相关表格（ai_conversations, ai_conversation_messages）
3. 新增了课程材料表（course_materials）
4. 补充了积分系统和成就系统的完整字段说明
5. 修正了所有表的字段名称和约束信息，确保与当前模型完全同步
6. 新增了collection_items表的说明
7. 完善了所有外键关系和约束条件的描述
8. 更新了技术特性说明，包括向量搜索和JSONB字段的使用
