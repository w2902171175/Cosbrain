/*
    YARA规则 - 恶意软件检测
    用于检测常见的恶意软件特征
*/

rule Suspicious_PE_Header
{
    meta:
        description = "检测可疑的PE文件头"
        author = "Security Team"
        date = "2024-01-01"
        threat_level = "medium"
        
    strings:
        $pe_header = {4D 5A}  // MZ header
        $suspicious_1 = "UPX"  // UPX packer
        $suspicious_2 = "PEC2"  // PECrypt packer
        $suspicious_3 = "FSG"   // FSG packer
        
    condition:
        $pe_header at 0 and any of ($suspicious_*)
}

rule Embedded_Executable
{
    meta:
        description = "检测嵌入式可执行文件"
        author = "Security Team"
        date = "2024-01-01"
        threat_level = "high"
        
    strings:
        $mz = {4D 5A}  // MZ header
        $pe = "PE"
        
    condition:
        $mz and $pe and filesize < 10MB
}

rule Suspicious_URLs
{
    meta:
        description = "检测可疑URL"
        author = "Security Team"
        date = "2024-01-01"
        threat_level = "medium"
        
    strings:
        $url_1 = /https?:\/\/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/  // IP-based URLs
        $url_2 = /https?:\/\/[a-z0-9]{20,}\.tk/                   // Suspicious .tk domains
        $url_3 = /https?:\/\/[a-z0-9]{20,}\.ml/                   // Suspicious .ml domains
        $url_4 = "bit.ly"
        $url_5 = "tinyurl"
        $url_6 = "t.co"
        
    condition:
        any of them
}

rule Suspicious_Strings
{
    meta:
        description = "检测可疑字符串"
        author = "Security Team"
        date = "2024-01-01"
        threat_level = "medium"
        
    strings:
        $str_1 = "cmd.exe" nocase
        $str_2 = "powershell" nocase
        $str_3 = "reg add" nocase
        $str_4 = "taskkill" nocase
        $str_5 = "schtasks" nocase
        $str_6 = "netsh" nocase
        $str_7 = "wmic" nocase
        $str_8 = "rundll32" nocase
        $str_9 = "regsvr32" nocase
        $str_10 = "certutil" nocase
        
    condition:
        3 of them
}

rule Potential_Keylogger
{
    meta:
        description = "检测潜在的键盘记录器"
        author = "Security Team"
        date = "2024-01-01"
        threat_level = "high"
        
    strings:
        $api_1 = "GetAsyncKeyState" nocase
        $api_2 = "SetWindowsHookEx" nocase
        $api_3 = "GetKeyState" nocase
        $api_4 = "RegisterHotKey" nocase
        $keyword_1 = "keylog" nocase
        $keyword_2 = "keystroke" nocase
        
    condition:
        2 of ($api_*) or any of ($keyword_*)
}

rule Crypto_Mining
{
    meta:
        description = "检测加密货币挖矿程序"
        author = "Security Team"
        date = "2024-01-01"
        threat_level = "medium"
        
    strings:
        $mining_1 = "stratum+tcp" nocase
        $mining_2 = "xmrig" nocase
        $mining_3 = "claymore" nocase
        $mining_4 = "ethminer" nocase
        $mining_5 = "cgminer" nocase
        $mining_6 = "bfgminer" nocase
        $mining_7 = "minerd" nocase
        $coin_1 = "bitcoin" nocase
        $coin_2 = "ethereum" nocase
        $coin_3 = "monero" nocase
        
    condition:
        any of ($mining_*) or 2 of ($coin_*)
}

rule Ransomware_Indicators
{
    meta:
        description = "检测勒索软件指标"
        author = "Security Team"
        date = "2024-01-01"
        threat_level = "critical"
        
    strings:
        $ransom_1 = "encrypted" nocase
        $ransom_2 = "decrypt" nocase
        $ransom_3 = "ransom" nocase
        $ransom_4 = "bitcoin" nocase
        $ransom_5 = "payment" nocase
        $ransom_6 = "restore" nocase
        $ransom_7 = "files have been" nocase
        $ext_1 = ".locked"
        $ext_2 = ".crypto"
        $ext_3 = ".encrypt"
        
    condition:
        3 of ($ransom_*) or any of ($ext_*)
}

rule Backdoor_Indicators
{
    meta:
        description = "检测后门程序指标"
        author = "Security Team"
        date = "2024-01-01"
        threat_level = "high"
        
    strings:
        $backdoor_1 = "CreateRemoteThread" nocase
        $backdoor_2 = "VirtualAllocEx" nocase
        $backdoor_3 = "WriteProcessMemory" nocase
        $backdoor_4 = "CreateProcess" nocase
        $backdoor_5 = "ShellExecute" nocase
        $network_1 = "InternetOpen" nocase
        $network_2 = "HttpOpenRequest" nocase
        $network_3 = "send" nocase
        $network_4 = "recv" nocase
        
    condition:
        2 of ($backdoor_*) and 2 of ($network_*)
}

rule Suspicious_Archive
{
    meta:
        description = "检测可疑压缩文件"
        author = "Security Team"
        date = "2024-01-01"
        threat_level = "medium"
        
    strings:
        $zip_header = {50 4B 03 04}
        $rar_header = {52 61 72 21}
        $exe_in_zip = {4D 5A}
        
    condition:
        ($zip_header at 0 or $rar_header at 0) and $exe_in_zip
}

rule Document_Macro
{
    meta:
        description = "检测包含宏的文档"
        author = "Security Team"
        date = "2024-01-01"
        threat_level = "medium"
        
    strings:
        $office_header = {D0 CF 11 E0 A1 B1 1A E1}  // OLE header
        $macro_1 = "Auto_Open" nocase
        $macro_2 = "Document_Open" nocase
        $macro_3 = "Workbook_Open" nocase
        $macro_4 = "Shell" nocase
        $macro_5 = "CreateObject" nocase
        
    condition:
        $office_header at 0 and 2 of ($macro_*)
}
