
---

# **鸿庆书云创新协作平台后端API文档 - 3.10 聊天室与消息、社交功能**

## **目录**

10. **聊天室与消息、社交功能**
 * 3.10.1 聊天室（Chat Room）管理
 * 3.10.2 聊天室成员（Chat Room Member）管理
 * 3.10.3 聊天室消息（Chat Message）管理
 * 3.10.4 用户关注与粉丝功能

---

## **公共基础模型**

### `schemas.ChatRoomCreate` (用于创建聊天室请求)

* `name` (str): 聊天室名称，在全局范围内唯一。
* `description` (Optional[str]): 聊天室描述。
* `visibility` (Literal["public", "private"], default="public"): 聊天室可见性。
 * `"public"`: 所有人可见并可申请加入。
 * `"private"`: 只有被邀请或知道链接的人才能看到和申请。
* `require_approval` (bool, default=True): 加入是否需要群主/管理员审批。
* `max_members` (Optional[int]): 最大成员数限制。

### `schemas.ChatRoomUpdate` (用于更新聊天室请求)

* 所有字段均为 `Optional`，只更新提供的字段。字段定义与 `ChatRoomCreate` 相同。

### `schemas.ChatRoomResponse` (用于聊天室响应)

* `id` (int): 聊天室ID。
* `creator_id` (int): 创建者（群主）ID。
* `creator_name` (Optional[str]): 创建者名称（辅助字段）。
* `name` (str): 聊天室名称。
* `description` (Optional[str]): 描述。
* `visibility` (str): 可见性。
* `require_approval` (bool): 是否需要审批。
* `max_members` (Optional[int]): 最大成员数。
* `created_at` (datetime): 创建时间。
* `updated_at` (Optional[datetime]): 更新时间。
* `members_count` (int): 活跃成员数量（辅助字段）。
* `last_message` (Optional[Dict[str, str]]): 最新消息摘要，包含`sender`和`content`（辅助字段）。
* `unread_messages_count` (int): 未读消息数量（占位符，当前可能为0）。
* `online_members_count` (int): 在线成员数量（占位符，当前可能为0）。

### `schemas.ChatJoinRequestCreate` (用于加入聊天室申请请求)

* `message` (Optional[str]): 申请加入的留言。

### `schemas.ChatJoinRequestResponse` (用于加入聊天室申请响应)

* `id` (int): 申请ID。
* `room_id` (int): 聊天室ID。
* `applicant_id` (int): 申请者ID。
* `applicant_name` (Optional[str]): 申请者姓名（辅助字段）。
* `applicant_email` (Optional[EmailStr]): 申请者邮箱（辅助字段）。
* `message` (Optional[str]): 申请留言。
* `status` (Literal["pending", "approved", "rejected"]): 申请状态。
* `applied_at` (datetime): 申请时间。
* `processed_at` (Optional[datetime]): 处理时间。
* `processed_by_id` (Optional[int]): 处理者ID。

### `schemas.ChatJoinRequestProcess` (用于处理加入申请请求)

* `status` (Literal["approved", "rejected"]): 处理结果。
* `process_message` (Optional[str]): 处理附言（例如拒绝原因）。

### `schemas.ChatRoomMemberUpdateRole` (用于更新成员角色请求)

* `role` (Literal["member", "admin"]): 成员新角色。

### `schemas.ChatRoomMemberResponse` (用于聊天室成员响应)

* `id` (int): 成员记录ID。
* `room_id` (int): 聊天室ID。
* `member_id` (int): 成员用户ID。
* `member_name` (Optional[str]): 成员姓名（辅助字段）。
* `member_email` (Optional[EmailStr]): 成员邮箱（辅助字段）。
* `role` (Literal["member", "admin"]): 成员角色。
* `status` (Literal["active", "inactive"]): 成员状态。
* `joined_at` (datetime): 加入时间。
* `last_active_at` (Optional[datetime]): 最后活跃时间。

### `schemas.ChatMessageCreate` (用于发送聊天消息请求)

* `content_text` (Optional[str]): 消息文本内容。
* `message_type` (Literal["text", "image", "file", "voice"], default="text"): 消息类型。
* `media_url` (Optional[str]): 媒体文件URL（图片、文件、语音）。

### `schemas.ChatMessageResponse` (用于聊天消息响应)

* `id` (int): 消息ID。
* `room_id` (int): 聊天室ID。
* `sender_id` (int): 发送者ID。
* `sender_name` (Optional[str]): 发送者姓名（辅助字段）。
* `content_text` (Optional[str]): 消息文本内容。
* `message_type` (str): 消息类型。
* `media_url` (Optional[str]): 媒体文件URL。
* `sent_at` (datetime): 消息发送时间。

### `schemas.UserFollowResponse` (用于用户关注响应)

* `id` (int): 关注关系ID。
* `follower_id` (int): 关注者用户ID。
* `followed_id` (int): 被关注者用户ID。
* `followed_at` (datetime): 关注时间。
* `follower_name` (Optional[str]): 关注者姓名（辅助字段）。
* `followed_name` (Optional[str]): 被关注者姓名（辅助字段）。

---

## **3.10 聊天室与消息、社交功能**

### **3.10.1 聊天室（Chat Room）管理**

#### **3.10.1.1 `POST /chat-rooms/` 创建新聊天室**

* **摘要**: 创建一个新的聊天室。创建者（当前认证用户）将自动成为群主和活跃成员。
* **权限**: 已认证用户。
* **请求体**: `schemas.ChatRoomCreate`
* **响应体**: `schemas.ChatRoomResponse`
* **常见状态码**: `200 OK` (创建成功), `401 Unauthorized` (未认证), `409 Conflict` (聊天室名称已存在)

#### **3.10.1.2 `GET /chat-rooms/` 获取所有聊天室列表**

* **摘要**: 获取所有可见的聊天室列表。
* **权限**: 已认证用户。
* **查询参数**:
 * `visibility_filter` (Optional[Literal["public", "private", "all"]]): 过滤聊天室可见性。
 * `"public"`: 只返回公开聊天室。
 * `"private"`: 只返回私有聊天室 (仅当你可见时)。
 * `"all"`: 返回所有你可见的聊天室。
 * `current_user_only` (Optional[bool]): `True` 则只返回当前用户已加入或创建的聊天室。
* **响应体**: `List[schemas.ChatRoomResponse]`
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证)

#### **3.10.1.3 `GET /chatrooms/{room_id}` 获取指定聊天室详情**

* **摘要**: 获取指定ID聊天室的详细信息。
* **权限**: 聊天室创建者、活跃成员或系统管理员。
* **路径参数**:
 * `room_id` (int): 聊天室的唯一标识符。
* **响应体**: `schemas.ChatRoomResponse`
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证), `403 Forbidden` (无权限), `404 Not Found` (聊天室不存在)

#### **3.10.1.4 `PUT /chatrooms/{room_id}` 更新指定聊天室**

* **摘要**: 更新指定ID聊天室的详细信息。
* **权限**: 聊天室创建者或系统管理员。
* **路径参数**:
 * `room_id` (int): 聊天室ID。
* **请求体**: `schemas.ChatRoomUpdate`
* **响应体**: `schemas.ChatRoomResponse`
* **常见状态码**: `200 OK` (更新成功), `401 Unauthorized` (未认证), `403 Forbidden` (无权限), `404 Not Found` (聊天室不存在), `409 Conflict` (名称重复)

#### **3.10.1.5 `DELETE /chatrooms/{room_id}` 删除指定聊天室**

* **摘要**: 删除指定ID的聊天室。同时会级联删除所有相关联的成员记录、加入申请和消息历史。
* **权限**: 聊天室创建者或系统管理员。
* **路径参数**:
 * `room_id` (int): 聊天室ID。
* **响应体**: 空响应体 (`204 No Content`)。
* **常见状态码**: `204 No Content` (删除成功), `401 Unauthorized` (未认证), `403 Forbidden` (无权限), `404 Not Found` (聊天室不存在)

### **3.10.2 聊天室成员（Chat Room Member）管理**

#### **3.10.2.1 `POST /chat-rooms/{room_id}/join-request` 学生申请加入聊天室**

* **摘要**: 用户申请加入指定聊天室。
* **权限**: 已认证用户。
* **路径参数**:
 * `room_id` (int): 聊天室ID。
* **请求体**: `schemas.ChatJoinRequestCreate`
 * `message` (Optional[str]): 申请留言。
* **响应体**: `schemas.ChatJoinRequestResponse`
* **常见状态码**: `200 OK` (申请成功), `401 Unauthorized` (未认证), `404 Not Found` (聊天室不存在), `400 Bad Request` (已是成员), `409 Conflict` (已有待处理申请)

#### **3.10.2.2 `GET /chat-rooms/{room_id}/join-requests` 获取聊天室所有加入申请列表**

* **摘要**: 获取指定聊天室的所有加入申请列表。可根据申请状态进行筛选。
* **权限**: 聊天室创建者或系统管理员。
* **路径参数**:
 * `room_id` (int): 聊天室ID。
* **查询参数**:
 * `status_filter` (Optional[Literal["pending", "approved", "rejected"]]): 筛选申请状态。
* **响应体**: `List[schemas.ChatJoinRequestResponse]`
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证), `403 Forbidden` (无权限), `404 Not Found` (聊天室不存在)

#### **3.10.2.3 `POST /chat-rooms/join-requests/{request_id}/process` 处理加入聊天室申请**

* **摘要**: 批准或拒绝一个加入聊天室的申请。如果申请被批准，对应的用户将成为该聊天室的成员。
* **权限**: 聊天室创建者或系统管理员。
* **路径参数**:
 * `request_id` (int): 申请记录ID。
* **请求体**: `schemas.ChatJoinRequestProcess`
* **响应体**: `schemas.ChatJoinRequestResponse`
* **常见状态码**: `200 OK` (处理成功), `400 Bad Request` (申请状态非待处理), `401 Unauthorized` (未认证), `403 Forbidden` (无权限), `404 Not Found` (申请不存在)

#### **3.10.2.4 `GET /chat-rooms/{room_id}/members` 获取聊天室成员列表**

* **摘要**: 获取指定聊天室的所有活跃成员列表。
* **权限**: 聊天室创建者、活跃成员或系统管理员。
* **路径参数**:
 * `room_id` (int): 聊天室ID。
* **响应体**: `List[schemas.ChatRoomMemberResponse]`
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证), `403 Forbidden` (无权限), `404 Not Found` (聊天室不存在)

#### **3.10.2.5 `PUT /chat-rooms/{room_id}/members/{member_id}/set-role` 设置聊天室成员角色**

* **摘要**: 设置指定聊天室成员的角色（普通成员或管理员）。
* **权限**: 聊天室创建者或系统管理员。
* **路径参数**:
 * `room_id` (int): 聊天室ID。
 * `member_id` (int): 目标成员的用户ID。
* **请求体**: `schemas.ChatRoomMemberUpdateRole`
* **响应体**: `schemas.ChatRoomMemberResponse`
* **常见状态码**: `200 OK` (设置成功), `401 Unauthorized` (未认证), `403 Forbidden` (无权限，例如不能设置自己的权限，不能降级群主), `404 Not Found` (聊天室或成员不存在), `400 Bad Request` (尝试设置不合法的角色)

#### **3.10.2.6 `DELETE /chat-rooms/{room_id}/members/{member_id}` 移除聊天室成员**

* **摘要**: 从指定聊天室中移除成员（包括自己退出）。
* **权限**: 聊天室创建者、系统管理员（可移除其他人），或被移除的成员本人（只能移除自己）。
* **路径参数**:
 * `room_id` (int): 聊天室ID。
 * `member_id` (int): 要移除的成员的用户ID。
* **响应体**: 空响应体 (`204 No Content`)。
* **常见状态码**: `204 No Content` (移除成功), `401 Unauthorized` (未认证), `403 Forbidden` (无权限，不能移除群主), `404 Not Found` (聊天室或成员不存在)

### **3.10.3 聊天室消息（Chat Message）管理**

#### **3.10.3.1 `POST /chatrooms/{room_id}/messages/` 在指定聊天室发送新消息**

* **摘要**: 在指定聊天室中发送一条新消息。支持文本、图片、文件和语音消息类型。
* **权限**: 聊天室创建者或活跃成员。
* **路径参数**:
 * `room_id` (int): 聊天室ID。
* **请求体**: `schemas.ChatMessageCreate`
* **响应体**: `schemas.ChatMessageResponse`
* **常见状态码**: `200 OK` (发送成功), `401 Unauthorized` (未认证), `403 Forbidden` (无权限), `404 Not Found` (聊天室不存在)
* **WebSocket**: 此接口通常与 WebSocket 消息实时推送结合使用以获得最佳体验。

#### **3.10.3.2 `GET /chatrooms/{room_id}/messages/` 获取指定聊天室的历史消息**

* **摘要**: 获取指定聊天室的历史消息列表。支持分页。
* **权限**: 聊天室创建者、活跃成员或系统管理员。
* **路径参数**:
 * `room_id` (int): 聊天室ID。
* **查询参数**:
 * `limit` (int, default=50): 限制返回消息数量。
 * `offset` (int, default=0): 偏移量，用于分页加载。
* **响应体**: `List[schemas.ChatMessageResponse]`
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证), `403 Forbidden` (无权限), `404 Not Found` (聊天室不存在)

### **3.10.4 用户关注与粉丝功能**

#### **3.10.4.1 `POST /users/{user_id}/follow` 关注指定用户**

* **摘要**: 当前认证用户关注指定ID的用户。
* **权限**: 已认证用户。
* **路径参数**:
 * `user_id` (int): 要关注的用户的ID。
* **请求体**: 无请求体。
* **响应体**: `schemas.UserFollowResponse` (成功创建的关注关系)。
* **常见状态码**: `200 OK` (关注成功), `401 Unauthorized` (未认证), `400 Bad Request` (不能关注自己), `404 Not Found` (用户不存在), `409 Conflict` (已关注)。

#### **3.10.4.2 `DELETE /users/{user_id}/unfollow` 取消关注指定用户**

* **摘要**: 当前认证用户取消关注指定ID的用户。
* **权限**: 已认证用户。
* **路径参数**:
 * `user_id` (int): 要取消关注的用户的ID。
* **响应体**: 空响应体 (`204 No Content`)。
* **常见状态码**: `204 No Content` (取消关注成功), `401 Unauthorized` (未认证), `404 Not Found` (未关注该用户或用户不存在)。

#### **3.10.4.3 `GET /users/me/following` 获取当前用户关注的用户列表**

* **摘要**: 获取当前认证用户关注的所有用户列表。
* **权限**: 已认证用户。
* **响应体**: `List[schemas.UserFollowResponse]` (列表中的 `followed_id` 对应被关注的用户)。
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证)。

#### **3.10.4.4 `GET /users/me/followers` 获取当前用户的粉丝列表**

* **摘要**: 获取当前认证用户的粉丝（关注者）列表。
* **权限**: 已认证用户。
* **响应体**: `List[schemas.UserFollowResponse]` (列表中的 `follower_id` 对应关注你的用户)。
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证)。

---

