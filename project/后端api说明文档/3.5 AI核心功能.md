
---

# **鸿庆书云创新协作平台后端API文档 - 3.5 AI核心功能**

## **目录**

5. **AI核心功能**
 * 3.5.1 `GET /llm/available-models` 获取可配置的LLM服务商及模型列表
 * 3.5.2 `POST /ai/qa` AI智能问答 (通用、RAG或工具调用)
 * 3.5.3 `POST /ai/web-search` 执行一次网络搜索 (AI工具的独立调用)
 * 3.5.4 `POST /search/semantic` 智能语义搜索

---

## **公共基础模型 `schemas.AIConversationMessageResponse` 和 `schemas.WebSearchResult`**

### `schemas.AIConversationMessageResponse` (用于AI问答历史消息)

* `id` (int): 消息ID。
* `conversation_id` (int): 所属对话ID。
* `role` (Literal["user", "assistant", "tool_call", "tool_output"]): 消息角色。
 * `"user"`: 用户输入。
 * `"assistant"`: LLM的最终回答。
 * `"tool_call"`: LLM决定调用工具（例如RAG、网络搜索、MCP工具）。
 * `"tool_output"`: 工具执行后的返回结果。
* `content` (str): 消息内容（文本）。
* `tool_calls_json` (Optional[Dict[str, Any]]): 如果角色是`"tool_call"`，存储工具调用的详细JSON数据。
* `tool_output_json` (Optional[Dict[str, Any]]): 如果角色是`"tool_output"`，存储工具输出的详细JSON数据。
* `llm_type_used` (Optional[str]): 本次消息生成时使用的LLM类型。
* `llm_model_used` (Optional[str]): 本次消息生成时使用的LLM模型ID。
* `sent_at` (datetime): 消息发送时间。

### `schemas.WebSearchResult` (用于网络搜索结果)

* `title` (str): 搜索结果标题。
* `snippet` (str): 搜索结果摘要。
* `url` (str): 搜索结果链接。
* `relevance_score` (Optional[float]): 相关性得分（如果重排成功）。

### `schemas.SemanticSearchResult` (用于语义搜索结果)

* `id` (int): 匹配到的内容的ID。
* `title` (str): 匹配到的内容的标题。
* `type` (Literal["project", "course", "knowledge_article", "note", "student"]): 匹配到的内容类型。
* `content_snippet` (str): 匹配到的内容摘要片段。
* `relevance_score` (float): 相关性得分（由嵌入相似度和重排器共同决定）。

---

## **3.5 AI核心功能**

### **3.5.1 `GET /llm/available-models` 获取可配置的LLM服务商及模型列表**

* **摘要**: 返回平台支持的所有LLM服务商类型、其默认模型和可用模型列表，以及配置提示。
* **权限**: 已认证用户。
* **请求体**: 无。
* **响应体**: `Dict[str, Dict[str, Any]]`
 * 键为LLM服务商类型（例如`"openai"`, `"zhipu"`, `"siliconflow"`, `"custom_openai"`）。
 * 值为包含以下字段的字典：
 * `default_model` (Optional[str]): 默认模型ID。
 * `available_models` (List[str]): 可用模型ID列表。
 * `notes` (str): 配置提示或注意事项。
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证)

### **3.5.2 `POST /ai/qa` AI智能问答 (通用、RAG或工具调用)**

* **摘要**: 使用LLM进行多轮问答，并支持对话历史记录。可配置为通用问答、基于知识库/笔记的RAG（检索增强生成）或智能工具调用（如网络搜索、MCP工具）。
* **权限**: 已认证用户。
* **请求体**: `schemas.AIQARequest`
 * `query` (str): 用户的问题或指令。
 * `kb_ids` (Optional[List[int]]): 当使用RAG模式时，指定要检索的知识库ID列表。
 * `note_ids` (Optional[List[int]]): 当使用RAG模式时，指定要检索的笔记ID列表。
 * `use_tools` (Optional[bool]): `True` 表示允许LLM根据问题自行判断并调用工具（RAG、网络搜索、MCP工具）；`False` 表示仅进行通用问答。默认为 `False`。
 * `preferred_tools` (Optional[List[Literal["rag", "web_search", "mcp_tool"]]]): 当 `use_tools` 为 `True` 时，可指定LLM优先考虑使用的工具类型。
 * `llm_model_id` (Optional[str]): 本次问答指定使用的LLM模型ID。如果未提供，则使用用户在个人设置中配置的默认模型。
 * `conversation_id` (Optional[int]): 要继续的对话Session ID。如果为空，则开始新的对话。
* **响应体**: `schemas.AIQAResponse`
 * `answer` (str): LLM生成的最终答案。
 * `answer_mode` (str): 本次回答的模式，例如`"General_mode"` (通用问答), `"RAG_mode"` (RAG模式), `"Tool_Use_mode"` (工具调用模式), `"Failed_General_mode"` (通用问答失败), `"Tool_Use_Failed_Answer"` (工具调用但LLM未能生成明确答案)。
 * `llm_type_used` (Optional[str]): 本次问答实际使用的LLM类型。
 * `llm_model_used` (Optional[str]): 本次问答实际使用的LLM模型ID。
 * `conversation_id` (int): 当前问答所关联的对话Session ID。
 * `turn_messages` (List[schemas.AIConversationMessageResponse]): 当前轮次（包括用户问题、LLM中间步骤、工具输出和AI最终回复）产生的完整消息序列。
 * `source_articles` (Optional[List[Dict[str, Any]]]): RAG模式下引用的来源文章信息，包含`title`和`content_snippet`等（如果响应中明确返回）。
 * `search_results` (Optional[List[Dict[str, Any]]]): 网络搜索结果摘要，包含`title`, `snippet`, `url`等（如果使用了网络搜索）。
* **常见状态码**: `200 OK` (成功回答), `400 Bad Request` (用户未配置LLM密钥), `401 Unauthorized` (未认证), `404 Not Found` (指定对话或用户不存在), `500 Internal Server Error` (LLM API调用失败，密钥解密失败), `503 Service Unavailable` (LLM服务暂时不可用)

### **3.5.3 `POST /ai/web-search` 执行一次网络搜索 (AI工具的独立调用)**

* **摘要**: 使用用户配置的搜索引擎执行一次网络搜索。此接口通常作为AI工具被调用，但也可以单独进行测试或使用。
* **权限**: 已认证用户。
* **请求体**: `schemas.WebSearchRequest`
 * `query` (str): 搜索关键词。
 * `engine_config_id` (int): 指定要使用的搜索引擎配置ID。
* **响应体**: `schemas.WebSearchResponse`
 * `query` (str): 实际执行的搜索关键词。
 * `engine_used` (str): 使用的搜索引擎配置名称。
 * `results` (List[schemas.WebSearchResult]): 搜索结果列表。
 * `total_results` (int): 总搜索结果数量。
 * `search_time` (float): 搜索耗时（秒）。
* **常见状态码**: `200 OK` (搜索成功), `400 Bad Request` (未指定搜索引擎配置ID), `401 Unauthorized` (未认证), `404 Not Found` (指定搜索引擎配置不存在或未启用), `500 Internal Server Error` (API密钥解密失败), `503 Service Unavailable` (搜索服务调用失败)

### **3.5.4 `POST /search/semantic` 智能语义搜索**

* **摘要**: 通过语义搜索，在用户可访问的项目、课程、知识库文章、笔记以及用户自身资料中查找相关内容。搜索结果会根据语义相似度进行粗召回，并通过重排模型进行精排。此功能依赖于用户的硅基流动LLM配置生成嵌入向量。
* **权限**: 已认证用户。
* **请求体**: `schemas.SemanticSearchRequest`
 * `query` (str): 语义搜索的查询文本。
 * `item_types` (Optional[List[Literal["project", "course", "knowledge_article", "note", "student"]]]): 要搜索的实体类型列表。如果未提供，默认搜索所有类型。
 * `limit` (int, default=10): 返回的最多结果数量。
* **响应体**: `List[schemas.SemanticSearchResult]`
* **常见状态码**: `200 OK` (搜索成功), `401 Unauthorized` (未认证), `404 Not Found` (未找到可搜索内容或无匹配结果), `503 Service Unavailable` (无法生成查询嵌入或重排失败：通常因为用户未配置硅基流动LLM密钥或API调用失败)

---