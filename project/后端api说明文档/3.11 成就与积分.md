
# **鸿庆书云创新协作平台后端API文档 - 3.11 成就与积分**

## **目录**

11. **成就与积分**
 * 3.11.1 成就（Achievement）管理与查询
 * 3.11.2 积分（Points）管理与查询

---

## **公共基础模型**

### `schemas.AchievementBase` (用于创建和更新成就请求，通常由系统内部管理)

* `name` (str): 成就名称。
* `description` (str): 成就描述。
* `points_reward` (int): 获得此成就奖励的积分数。
* `criteria_key` (str): 达成成就的内部关键标识（例如：`"first_login"`, `"complete_1_course"`）。
* `criteria_value` (str): 达成成就的关键值（例如：`"True"`，`"1"`，`"completed"`）。
* `is_active` (bool, default=True): 成就是否激活，用户是否可以获得。
* `icon_url` (Optional[str]): 成就图标的URL。

### `schemas.AchievementResponse` (用于成就列表和详情响应)

* `id` (int): 成就ID。
* `name` (str): 成就名称。
* `description` (str): 成就描述。
* `points_reward` (int): 奖励积分。
* `criteria_key` (str): 内部判定键。
* `criteria_value` (str): 内部判定值。
* `is_active` (bool): 是否激活。
* `icon_url` (Optional[str]): 图标URL。
* `created_at` (datetime): 创建时间。
* `updated_at` (Optional[datetime]): 更新时间。

### `schemas.UserAchievementResponse` (用于用户已获得成就的响应)

* `id` (int): 用户成就记录ID。
* `student_id` (int): 获得成就的用户ID。
* `achievement_id` (int): 获得的成就ID。
* `achieved_at` (datetime): 获得时间。
* `is_notified` (bool): 是否已通知用户（通常用于前端红点提示）。
* `achievement_name` (Optional[str]): 成就名称（辅助字段，从关联成就获取）。
* `achievement_description` (Optional[str]): 成就描述（辅助字段）。
* `points_reward` (Optional[int]): 成就奖励积分（辅助字段）。
* `icon_url` (Optional[str]): 成就图标URL（辅助字段）。

### `schemas.PointsRewardRequest` (用于手动奖励积分的请求)

* `user_id` (int): 目标用户的ID。
* `amount` (int): 奖励的积分数量。
* `reason` (str): 奖励积分的原因。

### `schemas.PointTransactionResponse` (用于积分交易记录响应)

* `id` (int): 交易ID。
* `user_id` (int): 交易所属用户ID。
* `amount` (int): 积分变化量（正数为获得，负数为消耗）。
* `reason` (str): 交易原因。
* `transaction_type` (Literal["earn", "redeem", "admin_gift"]): 交易类型。
 * `"earn"`: 获得积分（例如：登录、完成任务）。
 * `"redeem"`: 消耗积分。
 * `"admin_gift"`: 管理员赠送。
* `created_at` (datetime): 交易时间。

---

## **3.11 成就与积分**

### **3.11.1 成就（Achievement）管理与查询**

#### **3.11.1.1 `POST /achievements/` 创建新成就**

* **摘要**: 创建一个新成就。通常由系统初始化或管理员手动添加。
* **权限**: 系统管理员。
* **请求体**: `schemas.AchievementBase`
* **响应体**: `schemas.AchievementResponse`
* **常见状态码**: `200 OK` (创建成功), `401 Unauthorized` (未认证), `403 Forbidden` (非管理员), `409 Conflict` (成就名称或 `criteria_key` 重复)

#### **3.11.1.2 `GET /achievements/` 获取所有成就列表**

* **摘要**: 获取平台上所有已定义的成就列表。
* **权限**: 已认证用户。
* **查询参数**:
 * `is_active` (Optional[bool]): 过滤条件：`True` 只返回激活的成就。
* **响应体**: `List[schemas.AchievementResponse]`
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证)

#### **3.11.1.3 `GET /achievements/{achievement_id}` 获取指定成就详情**

* **摘要**: 获取指定ID成就的详细信息。
* **权限**: 已认证用户。
* **路径参数**:
 * `achievement_id` (int): 成就的唯一标识符。
* **响应体**: `schemas.AchievementResponse`
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证), `404 Not Found` (成就不存在)

#### **3.11.1.4 `PUT /achievements/{achievement_id}` 更新指定成就**

* **摘要**: 更新指定ID成就的信息。
* **权限**: 系统管理员。
* **路径参数**:
 * `achievement_id` (int): 要更新的成就ID。
* **请求体**: `schemas.AchievementBase` (所有字段均为 `Optional`，只更新提供的字段)。
* **响应体**: `schemas.AchievementResponse`
* **常见状态码**: `200 OK` (更新成功), `401 Unauthorized` (未认证), `403 Forbidden` (非管理员), `404 Not Found` (成就不存在), `409 Conflict` (新名称或 `criteria_key` 重复)

#### **3.11.1.5 `DELETE /achievements/{achievement_id}` 删除指定成就**

* **摘要**: 删除指定ID的成就。同时会级联删除所有用户相关的成就获得记录。
* **权限**: 系统管理员。
* **路径参数**:
 * `achievement_id` (int): 要删除的成就ID。
* **响应体**: JSON对象 `{"message": "Achievement deleted successfully"}`。
* **常见状态码**: `200 OK` (删除成功), `401 Unauthorized` (未认证), `403 Forbidden` (非管理员), `404 Not Found` (成就不存在)

#### **3.11.1.6 `GET /users/me/achievements` 获取当前用户已获得成就列表**

* **摘要**: 获取当前认证用户已获得的所有成就列表。
* **权限**: 已认证用户。
* **响应体**: `List[schemas.UserAchievementResponse]`
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证)

#### **3.11.1.7 `PUT /users/me/achievements/{user_achievement_id}/mark-notified` 标记用户已获得成就为已通知**

* **摘要**: 标记一条用户已获得成就记录为已通知状态（`is_notified` 为 `True`）。通常用于前端消除红点提示。
* **权限**: 用户本人。
* **路径参数**:
 * `user_achievement_id` (int): 用户成就记录（`UserAchievement`表）的ID。
* **响应体**: `schemas.UserAchievementResponse` (更新后的用户成就详情)。
* **常见状态码**: `200 OK` (更新成功), `401 Unauthorized` (未认证), `403 Forbidden` (无权限), `404 Not Found` (记录不存在)。

### **3.11.2 积分（Points）管理与查询**

#### **3.11.2.1 `GET /users/me/points/redeemable` 获取当前用户可兑换积分物品（预留接口）**

* **摘要**: 获取当前用户可以兑换的积分物品或服务列表。此接口目前仅为占位符，需后续实现具体积分商城逻辑。
* **权限**: 已认证用户。
* **响应体**: `List[Dict[str, Any]]` (目前返回空列表)。
* **常见状态码**: `200 OK`

#### **3.11.2.2 `POST /admin/points/reward` 【管理员专用】手动奖励积分给指定用户**

* **摘要**: 管理员手动奖励或扣除（通过负数金额）积分给指定用户。每次操作都会生成积分交易记录。
* **权限**: 系统管理员。
* **请求体**: `schemas.PointsRewardRequest`
* **响应体**: JSON对象 `{"message": "Points rewarded successfully", "new_total_points": 1234}`。
* **常见状态码**: `200 OK` (奖励成功), `400 Bad Request` (金额不合法), `401 Unauthorized` (未认证), `403 Forbidden` (非管理员), `404 Not Found` (目标用户不存在), `500 Internal Server Error` (数据库操作失败)。

#### **3.11.2.3 `GET /users/me/points/transactions` 获取当前用户的积分交易记录**

* **摘要**: 获取当前认证用户的所有积分交易记录列表，按时间倒序排列。
* **权限**: 用户本人。
* **响应体**: `List[schemas.PointTransactionResponse]`
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证)。

#### **3.11.2.4 `GET /users/{user_id}/points/transactions` 【管理员专用】获取指定用户的积分交易记录**

* **摘要**: 管理员获取指定用户的积分交易记录列表。
* **权限**: 系统管理员。
* **路径参数**:
 * `user_id` (int): 目标用户的ID。
* **响应体**: `List[schemas.PointTransactionResponse]`
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证), `403 Forbidden` (非管理员), `404 Not Found` (用户不存在)。

---
