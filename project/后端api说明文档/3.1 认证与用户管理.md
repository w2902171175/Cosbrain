
---
# **鸿庆书云创新协作平台后端API文档 - 3.1 认证与用户管理**

## **目录**

1. **认证与用户管理**
 * 3.1.1 `POST /register` 用户注册
 * 3.1.2 `POST /token` 用户登录并获取JWT令牌
 * 3.1.3 `GET /users/me` 获取当前登录用户详情
 * 3.1.4 `PUT /users/me` 更新当前登录用户详情
 * 3.1.5 `GET /students/` 获取所有学生列表
 * 3.1.6 `GET /students/{student_id}` 获取指定学生详情
 * 3.1.7 `PUT /admin/users/{user_id}/set-admin` 【管理员专用】设置系统管理员权限

---

## **基本概念与公共字段**

* **Pydantic 模型**: API 请求和响应体均使用 Pydantic 模型进行数据验证和序列化。
* **认证**: 大多数需要用户信息的操作都需要有效的 JWT Bearer Token。认证流程请参阅 `POST /token`。Token需放在 `Authorization` 请求头中，格式为 `Bearer <your_token_here>`。
* **权限**:
 * **认证用户**: 任何已登录用户。
 * **创建者/所有者**: 资源的创建者或拥有者。
 * **管理员**: `is_admin` 为 `True` 的系统管理员。
* **时间戳**: 通常以 ISO 8601 格式 (`YYYY-MM-DDTHH:MM:SS.ffffffZ`) 返回。
* **`Optional[Type]`**: 表示该字段是可选的。
* **`Literal[...]`**: 表示该字段的值必须是给定列表中的一个。
* `**id**`: (int) 资源的唯一标识符。
* `**created_at**`: (datetime) 资源创建时间。
* `**updated_at**`: (datetime) 资源最后更新时间。
* `**combined_text**`: (str) 用于AI嵌入的组合文本字段，包含资源的多个关键文本信息。
* `**embedding**`: (List[float]) 资源的向量嵌入，用于语义搜索和AI匹配。

### **公共基础模型 `schemas.SkillWithProficiency`**

* **`name`** (str): 技能名称。
* **`level`** (Literal["初窥门径", "登堂入室", "融会贯通", "炉火纯青"]): 技能熟练度等级。

---

## **3.1 认证与用户管理**

### **3.1.1 `POST /register` 用户注册**

* **摘要**: 用户注册新账号。
* **权限**: 无需认证。
* **请求体**: `schemas.StudentCreate`
 * `email` (Optional[EmailStr]): 用户邮箱。与 `phone_number` 至少提供一个。
 * `phone_number` (Optional[str]): 用户手机号，11位数字。与 `email` 至少提供一个。
 * `password` (str): 用户密码，至少6位。
 * `username` (Optional[str]): 用户名，平台内唯一。若不提供则自动生成。
 * `school` (Optional[str]): 用户所在学校。
 * `name` (Optional[str]): 真实姓名。
 * `major` (Optional[str]): 专业。
 * `skills` (Optional[List[schemas.SkillWithProficiency]]): 技能列表，每个元素包含 `name` 和 `level`。
 * `interests` (Optional[str]): 兴趣描述。
 * `bio` (Optional[str]): 个人简介。
 * `awards_competitions` (Optional[str]): 获奖与竞赛经历。
 * `academic_achievements` (Optional[str]): 学术成就。
 * `soft_skills` (Optional[str]): 软技能。
 * `portfolio_link` (Optional[str]): 个人作品集链接。
 * `preferred_role` (Optional[str]): 偏好角色（例如：前端开发、项目经理）。
 * `availability` (Optional[str]): 可用时间（例如：每周20小时，暑假全职）。
 * `location` (Optional[str]): 学生所在地理位置。
* **响应体**: `schemas.StudentResponse`
 * `id` (int): 用户ID。
 * `username` (str): 用户名。
 * `email` (Optional[EmailStr]): 用户邮箱。
 * `phone_number` (Optional[str]): 用户手机号。
 * `school` (Optional[str]): 学校。
 * `name` (Optional[str]): 姓名。
 * `major` (Optional[str]): 专业。
 * `skills` (List[schemas.SkillWithProficiency]): 技能列表。
 * `interests` (Optional[str]): 兴趣。
 * `bio` (Optional[str]): 简介。
 * `awards_competitions` (Optional[str]): 获奖信息。
 * `academic_achievements` (Optional[str]): 学术成就。
 * `soft_skills` (Optional[str]): 软技能。
 * `portfolio_link` (Optional[str]): 作品集链接。
 * `preferred_role` (Optional[str]): 偏好角色。
 * `availability` (Optional[str]): 可用时间。
 * `location` (Optional[str]): 学生所在地。
 * `combined_text` (Optional[str]): 用于AI的组合文本（系统内部生成）。
 * `embedding` (Optional[List[float]]): 个人资料的嵌入向量（系统内部生成，用于AI匹配和搜索）。
 * `llm_api_type` (Optional[Literal["openai", "zhipu", "siliconflow", "huoshanengine", "kimi", "deepseek", "custom_openai"]]): 用户配置的LLM类型。
 * `llm_api_base_url` (Optional[str]): 用户配置的LLM基础URL。
 * `llm_model_id` (Optional[str]): 用户配置的LLM模型ID。
 * `llm_api_key_encrypted` (Optional[str]): 用户加密的LLM API Key (不会返回明文密钥，仅返回加密后的表示)。
 * `created_at` (datetime): 创建时间。
 * `updated_at` (Optional[datetime]): 更新时间。
 * `is_admin` (bool): 是否为管理员。
 * `total_points` (int): 用户总积分。
 * `last_login_at` (Optional[datetime]): 上次登录时间。
 * `login_count` (int): 总登录天数。
 * `completed_projects_count` (Optional[int]): 已完成项目数量（后端计算）。
 * `completed_courses_count` (Optional[int]): 已完成课程数量（后端计算）。
* **常见状态码**: `200 OK` (注册成功), `409 Conflict` (邮箱/手机号/用户名已注册)

### **3.1.2 `POST /token` 用户登录并获取JWT令牌**

* **摘要**: 通过用户凭证（邮箱或手机号）和密码获取JWT令牌。成功登录且首次今日登录会奖励积分并检查成就。
* **权限**: 无需认证。
* **请求体**: `application/x-www-form-urlencoded`
 * `username` (str): 用户的邮箱或手机号。
 * `password` (str): 用户密码。
* **响应体**: `schemas.Token`
 * `access_token` (str): 访问令牌。
 * `token_type` (str): 令牌类型，通常为`bearer`。
 * `expires_in_minutes` (int): 令牌过期时间（分钟）。
* **常见状态码**: `200 OK` (登录成功), `401 Unauthorized` (凭证错误), `500 Internal Server Error` (数据保存失败，例如积分/成就更新)

### **3.1.3 `GET /users/me` 获取当前登录用户详情**

* **摘要**: 获取当前登录用户的详细信息，包括其总积分、成就、创建并完成的项目数量和完成的课程数量。
* **权限**: 已认证用户。
* **响应体**: `schemas.StudentResponse` (同 `POST /register` 的响应体，但包含当前用户特定数据，如其LLM配置的加密密钥)。
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证), `404 Not Found` (用户不存在，通常不会发生，因为认证依赖用户存在)

### **3.1.4 `PUT /users/me` 更新当前登录用户详情**

* **摘要**: 更新当前登录用户的详细信息（如姓名、专业、技能、AI模型配置等）。用户个人资料的嵌入向量会在更新后自动重新计算。
* **权限**: 已认证用户。
* **请求体**: `schemas.StudentUpdate`
 * 所有字段均为 `Optional`，只更新提供的字段。`password` 字段在 `StudentUpdate` 中不存在，密码修改需要专门的接口（如果需要）。
 * `username` (Optional[str]): 用户名，唯一性检查。
 * `phone_number` (Optional[str]): 手机号，唯一性检查。
 * `skills` (Optional[List[schemas.SkillWithProficiency]]): 技能列表。
 * `location` (Optional[str]): 学生所在地理位置。
 * `llm_api_type` (Optional[Literal["openai", "zhipu", "siliconflow", "huoshanengine", "kimi", "deepseek", "custom_openai"]]): 用户选择的LLM服务商类型。
 * `llm_api_key` (Optional[str]): LLM API密钥（明文），会加密存储。**如果提供，会覆盖旧密钥；如果为空，表示清空旧密钥。**
 * `llm_api_base_url` (Optional[str]): LLM API基础URL（对于 `custom_openai` 类型尤其重要）。
 * `llm_model_id` (Optional[str]): LLM模型ID。
 * 其他 `StudentBase` 中的用户信息字段。
* **响应体**: `schemas.StudentResponse` (更新后的用户详情)。
* **常见状态码**: `200 OK` (更新成功), `401 Unauthorized` (未认证), `404 Not Found` (用户不存在), `409 Conflict` (用户名/手机号已被使用)

### **3.1.5 `GET /students/` 获取所有学生列表**

* **摘要**: 获取平台所有学生的概要列表。
* **权限**: 已认证用户。 (注：在实际应用中，此接口的权限通常会被限制为系统管理员，或仅返回部分公开信息。)
* **响应体**: `List[schemas.StudentResponse]` (每个元素为 `schemas.StudentResponse`，通常不包含敏感信息如加密密钥)。
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证)

### **3.1.6 `GET /students/{student_id}` 获取指定学生详情**

* **摘要**: 获取指定ID学生的详细信息。
* **权限**: 已认证用户。 (注：在实际应用中，此接口的权限也通常会被限制，例如只能查看自己的详情，或只能查看公开的学生信息。)
* **路径参数**:
 * `student_id` (int): 学生的唯一标识符。
* **响应体**: `schemas.StudentResponse`
* **常见状态码**: `200 OK` (成功获取), `401 Unauthorized` (未认证), `404 Not Found` (学生不存在)

### **3.1.7 `PUT /admin/users/{user_id}/set-admin` 【管理员专用】设置系统管理员权限**

* **摘要**: 设置或取消指定用户的系统管理员权限。
* **权限**: 系统管理员。
* **路径参数**:
 * `user_id` (int): 目标用户的ID。
* **请求体**: `schemas.UserAdminStatusUpdate`
 * `is_admin` (bool): `True` 表示设置为管理员，`False` 表示取消管理员权限。
* **响应体**: `schemas.StudentResponse` (更新后的用户详情)。
* **常见状态码**: `200 OK` (设置成功), `401 Unauthorized` (未认证), `403 Forbidden` (非管理员尝试操作), `404 Not Found` (用户不存在), `400 Bad Request` (系统管理员不能取消自己的权限)

