# 项目结构重构计划

## 当前问题分析

### 1. 现状问题
- `project/ai_providers` 目录包含了AI相关的提供者、配置和工具，但命名和组织不够清晰
- `project/config` 目录配置文件分散，缺乏统一的配置管理
- `project/utils` 目录过于庞大，包含了多个不同领域的工具类
- `logs` 目录位于项目根目录，但实际上是项目运行时数据
- 部分功能重复或边界不清晰

### 2. 目标架构
遵循 **领域驱动设计 (DDD)** 和 **清洁架构** 原则，建立清晰的分层结构：
- **表示层**: `routers/` (API路由)
- **应用层**: `services/` (业务逻辑服务)
- **领域层**: `models/` (领域模型)
- **基础设施层**: 配置、工具、AI提供者等

## 重构方案

### 阶段一：AI相关模块重构

#### 1.1 重命名和重组 `ai_providers` → `infrastructure/ai`
```
project/infrastructure/ai/
├── providers/           # AI服务提供者
│   ├── llm/
│   │   ├── __init__.py
│   │   ├── base.py     # llm_provider.py 重命名
│   │   └── factory.py  # provider_factory.py 部分内容
│   ├── embedding/
│   │   ├── __init__.py
│   │   ├── base.py     # embedding_provider.py 重命名
│   │   └── engine.py   # matching_engine.py 重命名
│   ├── rerank/
│   │   ├── __init__.py
│   │   └── base.py     # rerank_provider.py 重命名
│   ├── tts/
│   │   ├── __init__.py
│   │   └── base.py     # tts_provider.py 重命名
│   └── search/
│       ├── __init__.py
│       └── base.py     # search_provider.py 重命名
├── orchestration/       # AI编排和管理
│   ├── __init__.py
│   ├── orchestrator.py # agent_orchestrator.py 重命名
│   ├── manager.py      # provider_manager.py 重命名
│   └── factory.py      # provider_factory.py 主要内容
├── processing/          # 文档处理和工具
│   ├── __init__.py
│   └── documents.py    # document_processor.py 重命名
├── config/             # AI相关配置
│   ├── __init__.py
│   └── settings.py     # ai_config.py 重命名
└── __init__.py
```

#### 1.2 移动相关文件
- `ai_base.py` → `infrastructure/ai/base.py`
- `management_api.py` → `routers/ai/management.py` (API路由)
- `security_utils.py` → `infrastructure/security/ai_security.py`

### 阶段二：配置管理重构

#### 2.1 统一配置管理 `config` → `infrastructure/config`
```
project/infrastructure/config/
├── __init__.py
├── base.py             # 基础配置类
├── settings.py         # 主配置文件
├── database.py         # 数据库配置
├── ai.py              # AI相关配置 (从ai_providers/ai_config.py)
└── modules/           # 各模块配置
    ├── __init__.py
    ├── chatroom.py    # chatroom_config.py 重命名
    ├── collections.py # collections_config.py 重命名
    ├── projects.py    # projects_config.py 重命名
    ├── mcp.py         # mcp_config.py 重命名
    └── monitoring.py  # enhanced_monitoring_config.yaml 转换
```

### 阶段三：工具类重构

#### 3.1 重组 `utils` 目录 → `infrastructure/utils`
```
project/infrastructure/utils/
├── __init__.py
├── common/             # 通用工具
│   ├── __init__.py
│   ├── decorators.py   # 从utils/core/decorators.py
│   ├── operations.py   # 从utils/core/operations.py
│   └── helpers.py      # 从utils/core/common_utils.py
├── cache/              # 缓存相关
│   ├── __init__.py
│   └── async_cache.py  # 从utils/async_cache/
├── database/           # 数据库工具
│   ├── __init__.py
│   └── helpers.py      # 从utils/database/
├── security/           # 安全工具
│   ├── __init__.py
│   ├── file.py         # 从utils/security/file_security.py
│   ├── input.py        # 从utils/security/input_security.py
│   └── permissions.py  # 从utils/security/permissions.py
└── domain/             # 领域特定工具
    ├── __init__.py
    ├── collections.py  # 从utils/core/collections_*
    ├── courses.py      # 从utils/core/course_notes_utils.py
    └── forum.py        # 从utils/core/forum_utils.py
```

#### 3.2 移动其他工具类
```
# 移动到对应的服务或基础设施层
utils/ai/ → infrastructure/ai/utils/
utils/auth/ → infrastructure/auth/
utils/logging/ → infrastructure/logging/
utils/monitoring/ → infrastructure/monitoring/
utils/uploads/ → infrastructure/storage/
utils/recommendation/ → services/recommendation/utils/
utils/distributed/ → infrastructure/distributed/
utils/optimization/ → infrastructure/optimization/
```

### 阶段四：日志和监控重构

#### 4.1 重组日志目录
```
# 方案A：移入项目内部
project/infrastructure/storage/
├── logs/               # 从根目录logs/移入
│   ├── application/    # 从logs/app/
│   ├── access/
│   ├── security/
│   ├── audit/
│   ├── performance/
│   ├── metrics/
│   └── archive/
├── data/               # 数据文件
└── backups/            # 从logs/backup/

# 方案B：保持在外部但重新组织
runtime/                # 重命名logs为runtime
├── logs/
│   ├── application/
│   ├── system/
│   └── business/
├── data/
├── metrics/
└── monitoring/
```

### 阶段五：最终目录结构

```
project/
├── models/             # 领域模型 (保持不变)
├── schemas/            # API模式 (保持不变)
├── routers/            # API路由 (保持不变)
├── services/           # 业务服务 (保持不变)
└── infrastructure/     # 基础设施层 (新增)
    ├── ai/            # AI相关基础设施
    ├── config/        # 配置管理
    ├── utils/         # 工具类
    ├── storage/       # 存储相关
    ├── security/      # 安全相关
    ├── logging/       # 日志相关
    ├── monitoring/    # 监控相关
    ├── auth/          # 认证相关
    └── distributed/   # 分布式相关

runtime/               # 运行时数据 (重命名自logs)
├── logs/
├── data/
├── metrics/
└── monitoring/
```

## 实施计划

### 第一周：准备阶段
1. **备份当前代码** - 创建功能分支
2. **依赖分析** - 分析各文件间的导入依赖关系
3. **测试准备** - 确保现有测试用例完整

### 第二周：AI模块重构
1. **创建新目录结构** - `infrastructure/ai/`
2. **移动和重命名文件** - 按照上述方案移动AI相关文件
3. **更新导入路径** - 修改所有相关的import语句
4. **运行测试** - 确保功能正常

### 第三周：配置和工具类重构
1. **配置管理重构** - 创建统一的配置管理
2. **工具类重组** - 按功能域重新组织utils
3. **更新导入路径** - 修改相关import
4. **集成测试** - 全面测试

### 第四周：日志和收尾
1. **日志目录重构** - 决定并实施日志目录方案
2. **文档更新** - 更新README和相关文档
3. **代码审查** - 团队代码审查
4. **部署测试** - 在测试环境验证

## 风险控制

### 1. 技术风险
- **导入路径错误**: 使用IDE的重构功能，批量查找替换
- **循环依赖**: 重构前绘制依赖图，避免循环引用
- **配置丢失**: 确保配置文件正确迁移和合并

### 2. 业务风险
- **功能中断**: 分阶段实施，每个阶段都要通过测试
- **数据丢失**: 重构前完整备份
- **部署问题**: 在测试环境充分验证

### 3. 缓解措施
- 使用特性分支进行开发
- 每个阶段完成后进行代码审查
- 保持向后兼容性，逐步废弃旧的导入路径
- 建立完善的测试覆盖

## 预期收益

### 1. 代码质量提升
- **清晰的分层**: 基础设施、应用服务、领域模型分离明确
- **高内聚低耦合**: 相关功能聚合，减少跨模块依赖
- **易于维护**: 清晰的目录结构和命名规范

### 2. 开发效率提升
- **快速定位**: 开发者能快速找到相关代码
- **减少冲突**: 功能模块独立，减少合并冲突
- **易于扩展**: 新功能有明确的放置位置

### 3. 团队协作改善
- **统一规范**: 统一的代码组织方式
- **降低学习成本**: 新团队成员容易理解项目结构
- **代码审查效率**: 清晰的模块边界便于审查

## 后续维护

### 1. 代码规范
- 建立导入路径规范文档
- 设置IDE模板和代码片段
- 建立pre-commit钩子检查

### 2. 持续优化
- 定期审查目录结构合理性
- 根据业务发展调整模块划分
- 保持架构文档更新

---

**注意**: 本重构计划需要团队共同讨论和确认，特别是目录命名和组织方式的选择。建议先在小范围内试点，验证可行性后再全面实施。
